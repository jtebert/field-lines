{% extends 'page.html' %}

{% load static %}

{% block extra_css %}
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script type="text/javascript" src="{% static 'node_modules/vis/dist/vis.js' %}"></script>
    <link href="{% static 'node_modules/vis/dist/vis.css' %}" rel="stylesheet" type="text/css"/>
{% endblock %}

{% block page-content %}
<div class="col-md-6 no-gutter">
    <div id="mynetwork"></div>
</div>
<div class="col-md-6" id="search-results">
</div>

<script type="text/javascript">
    // create a network
    var container = document.getElementById('mynetwork');

    var options = {
        nodes: {
            borderWidth: 10,
            borderWidthSelected: 15,
            color: {
                border: '#E1E2E9',
                background: '#E1E2E9',
                highlight: {
                    border: '#fff',
                    background: '#fff'
                }
            },
            font: {
                size: 24,
                face: 'Open Sans',
                color: '#111'
            },
            shape: 'box',
            shapeProperties: {
                borderRadius: 0
            },
            scaling: {
                min: 10,
                max: 30,
                label: {
                    enabled: true,
                    min: 14,
                    max: 30,
                    maxVisible: 30,
                    drawThreshold: 5
                }
            }
        },
        edges: {
            color: {
                color: '#3f67c0',
                highlight: '#35b5eb'
            },
            selectionWidth: 4,
            scaling: {
                min: 3,
            }
        },
        physics: {
            barnesHut: {
                gravitationalConstant: -2000,
                springLength: 150
            }
        }
    };

    data = {
        nodes: [],
        edges: []
    };

    var network = new vis.Network(container, data, options);

    $(document).ready(function() {
        $.ajax({
            url: '/get-subject-network/',
            type: 'GET',
            data: [],

            success: function (data) {
                networkData = {
                    nodes: new vis.DataSet(data.nodes),
                    edges: new vis.DataSet(data.edges)
                };
                network.setData(networkData)
            },
            error: function (xhr, errmsg, err) {
                console.log(xhr.status + ": " + xhr.responseText)
            }
        });
    });

    function get_articles(subjects) {
        $.ajax({
            url: '/get-articles/',
            type: 'GET',
            data: {search_text : subjects},

            success : function(data) {
                console.log('success');
                //console.log(data)
                $('#search-results').html(data)
            },
            error: function (xhr, errmsg, err) {
                console.log(xhr.status + ": " + xhr.responseText)
            }
        })
    }

    // Get the corresponding articles when the node/edge is selected
    network.on('select', function(obj) {
        console.log('selection changed');
        if (obj.nodes.length == 0 && obj.edges.length == 0) {
            console.log('everything unselected')
        } else if (obj.nodes.length == 0) {
            console.log('edge selected')
            get_articles(obj.edges[0]);
        } else {
            console.log('node selected')
            get_articles(obj.nodes[0]);
        }
    });
</script>

{% endblock %}